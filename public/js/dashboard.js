// ______          _     _                         _     ___ _____
// |  _  \        | |   | |                       | |   |_  /  ___|
// | | | |__ _ ___| |__ | |__   ___   __ _ _ __ __| |     | \ `--.
// | | | / _` / __| '_ \| '_ \ / _ \ / _` | '__/ _` |     | |`--. \
// | |/ / (_| \__ \ | | | |_) | (_) | (_| | | | (_| | /\__/ /\__/ /
// |___/ \__,_|___/_| |_|_.__/ \___/ \__,_|_|  \__,_| \____/\____/
//
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⢋⣭⣝⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢡⣿⣿⣿⣷⣌⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠟⠛⢿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣾⡿⠛⣿⣿⣿⣧⡈⠻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢟⣡⣾⣿⣿⢸⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⣿⡇⠀⢸⣿⣿⣿⣿⣶⣌⠻⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢟⣵⣿⣿⣿⣿⡿⢸⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⢹⣧⣄⠈⣿⣿⣿⣿⣿⣿⣷⣤⡙⠻⣿⣿⠿⠛⠉⠉⠉⠛⠛⠛⠛⠻⠿⠿⠿⢟⣫⣵⣿⣿⣿⣿⣿⣿⠃⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡜⣿⣿⡀⢸⣿⣿⣿⣿⣿⣿⣿⠿⠂⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠛⠿⠿⣿⣿⣿⣿⣿⡟⣸⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣧⢻⣿⣿⣿⣿⣿⣿⣿⡿⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣤⡀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⢡⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡘⣿⣿⣿⣿⣿⠟⠉⠀⠀⠀⠀⠀⠀⠀⢀⣤⣤⣴⣷⣶⣾⣧⢠⣿⣷⣶⣾⣷⣀⠀⠀⠹⣿⣿⡇⣸⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡇⢻⣿⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀⠀⣠⣿⣿⣿⣿⣿⣿⣿⣿⠈⠻⢻⣿⣿⣿⣿⣿⣶⣶⣿⣿⠁⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣷⢸⣿⣿⣿⡇⠀⠀⠀⠀⣰⣶⣾⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⢸⣿⣿⣿⣿⣿⣿⣿⣿⣿⡆⢿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⢸⣿⡿⠉⠀⠀⢀⣴⣾⣿⣿⣿⡏⠀⠈⣿⡟⢿⣿⣿⣿⣿⠀⠀⠈⠻⣿⣿⠿⠿⡿⠉⣿⣿⣷⢸⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡏⠘⠋⠀⠀⠀⠀⠈⢹⣿⣿⣿⣿⣷⣄⠀⠀⣠⣾⣿⣿⣿⡿⠀⠀⠀⠀⠈⢿⣦⣄⣤⣴⣿⣿⣿⢀⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠁⠀⠀⠀⠀⠀⠀⠀⠈⠿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠁⠀⣄⠀⠀⣀⡈⠻⣿⣿⣿⣿⣿⣟⢸⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⣿⣿⣿⣿⣿⣿⣿⠿⠋⠀⠀⠀⠈⠑⣿⠋⠀⠀⠙⠻⣿⣿⣿⡟⢸⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⣿⣿⠿⠛⠉⠀⠀⠀⠀⠀⣠⡶⠛⠛⠓⢦⡀⠀⠀⠹⣿⠟⠀⠸⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠋⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⣿⣄⡀⠈⠉⠀⠀⠀⠀⠀⠀⠀⣠⠞⠁⠀⠀⠀⠀⠀⠹⠀⠀⡀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠙⠻⠿⠂⣀⣀⣠⡄⠀⠀⠀⠐⠁⠀⠀⠀⠀⠀⠀⠀⠀⢀⡐⡍⣷⡄⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠙⠛⠁⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠿⠟⠋⠁⠀⣼⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢠⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⠇⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⡟⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⡏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠹⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢻⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣿⠃⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠸⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿⣿
// ⣿⣿⣿⣿⣿⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣶⣿⣿⣿⣿⣿
//
$(function () {
    var teams = [], logos = [];
    var timerId, timerTimer, questionType;

    // Mmmm shimmy
    function toggleFullScreen() {
        if (!document.fullscreenElement &&
            !document.mozFullScreenElement &&
            !document.webkitFullscreenElement &&
            !document.msFullscreenElement) {
            if (document.documentElement.requestFullscreen) {
                document.documentElement.requestFullscreen();
            } else if (document.documentElement.msRequestFullscreen) {
                document.documentElement.msRequestFullscreen();
            } else if (document.documentElement.mozRequestFullScreen) {
                document.documentElement.mozRequestFullScreen();
            } else if (document.documentElement.webkitRequestFullscreen) {
                document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
            }
        } else {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            }
        }
    }
    document.addEventListener("keypress", function(e) {
        $('#presskey').hide();
        if (e.keyCode === 102) {
            toggleFullScreen();
        }
    }, false);

    function resetScreen() {
        $('header').hide();
        $('section').hide();
        $('.title').hide();
        $('#pictionary').hide();
        $('#ssr').hide();
        $('#question').html('');
    }

    function delay(n){
        return new Promise(function(resolve){
            setTimeout(resolve, n * 1000);
        });
    }

    var socket = io.connect('/dashboard'),
        wrongTimer = null;

    //  _____ _ _   _        _____
    // |_   _(_) | | |      /  ___|
    //   | |  _| |_| | ___  \ `--.  ___ _ __ ___  ___ _ __
    //   | | | | __| |/ _ \  `--. \/ __| '__/ _ \/ _ \ '_ \
    //   | | | | |_| |  __/ /\__/ / (__| | |  __/  __/ | | |
    //   \_/ |_|\__|_|\___| \____/ \___|_|  \___|\___|_| |_|
    socket
    .on('title show', function (event) {
        stopAllSound();
        stopAllVideo();
        nukeTimer();
        $('#intro_video').hide();
        $('header').hide();
        $('section').hide();
        $('.title').hide();
        $('#title_' + event.title.title).show();
        if (event.title.audio) {
            $('#' + event.title.audio)[0].play();
        }
        if (event.title.video) {
            $('#' + event.title.video)[0].play();
        }

        if (event.title.title == 'outro') {
            var ts = event.teams;
            ts.sort((a, b) => parseFloat(b.points) - parseFloat(a.points));

            var s = 1;
            for (let t in ts) {
                $('#outroteams').append(
                    '<div class="animated zoomInDown delay-' + s +
                    's" style="font-size: ' + (200 - (20 * s)) + '%;">' +
                    ts[t].name + ' (' + ts[t].points +
                    (ts[t].points == 1 ? ' point' : ' points') + ')</div>'
                );
                s++;
            }
        }
    });

    //  _____
    // |_   _|
    //   | | ___  __ _ _ __ ___  ___
    //   | |/ _ \/ _` | '_ ` _ \/ __|
    //   | |  __/ (_| | | | | | \__ \
    //   \_/\___|\__,_|_| |_| |_|___/
    //
    socket
    .on('teams list', function (ts) {
        teams = ts;
        for (let t in teams) {
            let team = teams[t];
            if (team.buzzer != null) {
                if (!$('#audio_team_' + team.id).length) {
                    var audio = document.createElement('audio');
                    audio.setAttribute('controls', '');
                    audio.setAttribute('id', 'audio_team_' + team.id);
                    $('#teambuzzers')[0].appendChild(audio);
                }

                var buzzerBlob = new Blob([team.buzzer], { 'type' : 'audio/ogg; codecs=opus' }),
                    audioURL = window.URL.createObjectURL(buzzerBlob);
                $('#audio_team_' + team.id)[0].src = audioURL;
            }
        }
        if ($('#teamscores').is(':visible')) {
            updateTeamScores();
        }
    })
    .on('teams logo', function (tid, data) {
        console.log("Got logo for Team[" + tid + "]");
        var img = new Image();
        img.src = data;
        logos[tid] = img;
    })
    .on('teams scores', function (event) {
        nukeTimer();
        teams = event.teams;

        updateTeamScores();

        window.setTimeout(
            function() {
                $('header').hide();
                $('section').hide();
                $('.title').hide();
                $('#teamscores').show();
            },
            3000
        );
    })
    .on('penalty', function (teamName) {
        console.log("Penality for Team[" + teamName + "]");
        $('#penalty_' + parseInt(Math.floor(Math.random() * 2)))[0].play();
        $('#penalty_popup span').html('PENALTY for ' + teamName + ' -1 point');
        $('#penalty_popup').show(0, function() {
            $(this).fadeOut(5000);
        });
    });

    var lastScores = [];
    function updateTeamScores () {
        $('#teamscorelist').empty();
        var ts = teams;
        ts.sort((a, b) => parseFloat(b.points) - parseFloat(a.points));

        var s = 500, size = 1;
        for (let t in ts) {
            var diff = '';
            $('#teamscorelist').append(
                '<div class="animated zoomInDown" style="font-size: ' + (250 - (12 * (size++))) +
                    '%; animation-delay: ' + s + 'ms;">' +
                ts[t].name + ' (' + ts[t].points +
                (ts[t].points == 1 ? ' point' : ' points') + ') ' + diff + '</div>'
            );
            s += 200;

            lastScores[ts[t].name] = ts[t].points;
        }
    }

    //  _____ _
    // |_   _(_)
    //   | |  _ _ __ ___   ___ _ __
    //   | | | | '_ ` _ \ / _ \ '__|
    //   | | | | | | | | |  __/ |
    //   \_/ |_|_| |_| |_|\___|_|
    //
    function nukeTimer() {
        if (timerTimer)
            clearInterval(timerTimer);
        if (timerId)
            $('#' + timerId).remove();
    }
    function timerRun () {
        let time = parseInt($('#' + timerId + ' span').html());
        --time;

        $('#' + timerId + ' span').html(time);

        if (time < 1) {
            $('#timer_horn')[0].play();
            clearInterval(timerTimer);
        } else if (time < 6) {
            $('#timer_tick')[0].play();
        }
    }
    socket
    .on('question timer', function (event) {
        if (!timerId)
            return;

        switch (event.action) {
            case 'start':
                timerTimer = setInterval(timerRun, 1000);
                if (questionType == 'catchphrase') {
                    $('#question div.catchphrase_hide').css('animation-play-state', 'running');
                }
                break;

            case 'pause':
                clearInterval(timerTimer);
                if (questionType == 'catchphrase') {
                    $('#question div.catchphrase_hide').css('animation-play-state', 'paused');
                }
                break;

            case 'reset':
                clearInterval(timerTimer);

                $('#' + timerId + ' span').html($('#' + timerId).attr("data-time"));
                if (questionType == 'catchphrase') {
                    $('#question div.catchphrase_hide').css('animation-play-state', 'running');
                }
                break;
        }
    });

    // ___  ___         _ _
    // |  \/  |        | (_)
    // | .  . | ___  __| |_  __ _
    // | |\/| |/ _ \/ _` | |/ _` |
    // | |  | |  __/ (_| | | (_| |
    // \_|  |_/\___|\__,_|_|\__,_|
    //
    function stopAllSound() {
        $('audio').each(function () {
            $(this)[0].pause();
            $(this)[0].currentTime = 0;
        });
    }
    function stopAllVideo() {
        $('video').each(function () {
            $(this)[0].pause();
            $(this)[0].currentTime = 0;
        });
    }

    socket
    .on('sound play', function (sound) {
        stopAllSound();
        stopAllVideo();
        $('#' + sound.sound)[0].play();
    })
    .on('sound stop', function () {
        stopAllSound();
        stopAllVideo();
    });

    //  _____                 _   _
    // |  _  |               | | (_)
    // | | | |_   _  ___  ___| |_ _  ___  _ __  ___
    // | | | | | | |/ _ \/ __| __| |/ _ \| '_ \/ __|
    // \ \/' / |_| |  __/\__ \ |_| | (_) | | | \__ \
    //  \_/\_\\__,_|\___||___/\__|_|\___/|_| |_|___/
    //
    socket
    .on('question play', function (msg) {
        nukeTimer();
        stopAllSound();
        resetScreen();

        $('#question')
        .append(
            $('<h1/>')
                .addClass('animated')
                .addClass('zoomInDown')
                .html(msg.question.title)
        );

        questionType = msg.question.type;
        switch (msg.question.type) {
            case 'timer':
            case 'text':
                $('#question').append(
                    $('<div />').append(
                        $('<span />')
                            .addClass('content')
                            .addClass('animated')
                            .addClass('zoomInDown')
                            .addClass('delay-1s')
                            .html(msg.question.text)
                    )
                );

                if (msg.question.type == 'timer') {
                    var timer = $('#timer').clone();
                    timerId = "timer_" + Math.floor(Math.random() * 1000);
                    $(timer).attr("id", timerId)
                            .attr("data-time", msg.question.timer)
                            .show(msg.question.timer);
                    $('#question div').append(timer);
                    $('span', timer).html(msg.question.timer);
                }
                break;

            case 'catchphrase':
                $('#question').append(
                    $('<div />').addClass('qhead').append(
                        $('<div />').addClass('catchphrase').append(
                            $('<img />')
                                .addClass('content')
                                .addClass('cp-image')
                                .prop('src', '/images/' + msg.question.image)
                        ).append(
                            $('<div />').addClass('catchphrase_hide')
                        )
                    )
                );

                var timer = $('#timer').clone();
                timerId = "timer_" + Math.floor(Math.random() * 1000);
                $(timer).attr("id", timerId)
                        .attr("data-time", msg.question.timer)
                        .show(msg.question.timer);
                $('#question div.qhead').append(timer);
                $('span', timer).html(msg.question.timer);
                break;

            case 'pictionary':
            case 'ssr':
                // Done in "init"
                break;

            case 'audio':
                let icon = $('#icon_music').clone();
                $(icon).attr("id","");
                $('#question').append(icon);
                break;
        }

        $('#question').show();
    })
    .on('question buzzed', function (event) {
        stopAllSound();

        if ($('#audio_team_' + event.team.id).length) {
            $('#audio_team_' + event.team.id)[0].play();
        } else {
            $('#' + event.sound)[0].play();
        }

        if (questionType == 'catchphrase') {
            clearInterval(timerTimer);
            $('#question div.catchphrase_hide').css('animation-play-state', 'paused');
        }

        $('#teamoverlay').html('').append(
            $('<div />')
                .addClass('animated')
                .addClass('zoomInDown')
                .html(event.team.name)
        ).append(
            $('<div />')
                .addClass('animated')
                .addClass('zoomInDown')
                .addClass('team_logo')
                .html(logos[event.team.id])
        ).show();
    })
    .on('question wrong', function (event) {
        $('#' + event.sound)[0].play();
        $('#teamoverlay').html('').hide();
        $('#answer_wrong').show();

        wrongTimer = window.setTimeout(
            function() {
                $('#answer_wrong').hide();
                if (questionType == 'catchphrase') {
                    timerTimer = setInterval(timerRun, 1000);
                    $('#question div.catchphrase_hide').css('animation-play-state', 'running');
                }
            },
            3000
        );
    })
    .on('question correct', function (event) {
        window.clearTimeout(wrongTimer);
        $('#' + event.sound)[0].play();
        $('#teamoverlay').html('').hide();
        $('#answer_correct').show();
    })
    .on('question losers', function (event) {
        window.clearTimeout(wrongTimer);
        $('#' + event.sound)[0].play();
        $('#teamoverlay').html('').hide();
        $('#answer_losers').show();
    });

    // ______ _      _   _
    // | ___ (_)    | | (_)
    // | |_/ /_  ___| |_ _  ___  _ __   __ _ _ __ _   _
    // |  __/| |/ __| __| |/ _ \| '_ \ / _` | '__| | | |
    // | |   | | (__| |_| | (_) | | | | (_| | |  | |_| |
    // \_|   |_|\___|\__|_|\___/|_| |_|\__,_|_|   \__, |
    //                                             __/ |
    //                                            |___/
    var canvasId  = 'pictionary_canvas',
        canvas    = document.getElementById(canvasId),
        canvasCtx = canvas.getContext("2d"),
        canvasW   = 350,
        canvasH   = 350; // Must match incoming canvas data!
    socket
    .on('pictionary init', function (team, totalQuestions, timerVal) {
        nukeTimer();
        $('section').hide();
        $('#pictionary').show();
        $('#pictionary h2').html("Team " + team);
        $('#pictionary h3').html("<span>0</span> of " + totalQuestions + " pictures");
        $('#pictionary h4').html("<span>0</span> Correct Answer(s)");

        canvasCtx.clearRect(0, 0, canvasW, canvasH);

        var timer = $('#timer').clone();
        timerId = "timer_" + Math.floor(Math.random() * 1000);
        $(timer).attr("id", timerId)
                .attr('data-time', timerVal)
                .show();
        $('#pictionary div').append(timer);
        $('#' + timerId + ' span').html(timerVal);
    })
    .on('pictionary start', function () {
        timerTimer = setInterval(timerRun, 1000);
    })
    .on('pictionary end', function () {
        clearInterval(timerTimer);
        $('#' + timerId).remove();
    })
    .on('pictionary active', function (active, score) {
        $('#pictionary h3 span').html(parseInt(active) + 1);
        $('#pictionary h4 span').html(score);
        canvasCtx.clearRect(0, 0, canvasW, canvasH);
    })
    .on('pictionary update', function(data) {
        canvasCtx.beginPath();
            canvasCtx.moveTo(data.x1, data.y1);
            canvasCtx.lineTo(data.x2, data.y2);
            canvasCtx.strokeStyle = data.c;
            canvasCtx.lineWidth = data.s;
            canvasCtx.stroke();
        canvasCtx.closePath();
    })
    .on('pictionary clear', function(data) {
        canvasCtx.clearRect(0, 0, canvasW, canvasH);
    })
    .on('pictionary fill', function(data) {
        canvasCtx.fillStyle = data.c;
        canvasCtx.fillRect(0, 0, canvasW, canvasH);
        canvasCtx.fillStyle = '#fff';
    });

    //
    //  _____             _        _       _____ _      _       _      ______ _     _
    // /  ___|           | |      ( )     /  ___| |    (_)     | |     | ___ (_)   | |
    // \ `--.  __ _ _ __ | |_ __ _|/ ___  \ `--.| | ___ _  __ _| |__   | |_/ /_  __| | ___
    //  `--. \/ _` | '_ \| __/ _` | / __|  `--. \ |/ _ \ |/ _` | '_ \  |    /| |/ _` |/ _ \
    // /\__/ / (_| | | | | || (_| | \__ \ /\__/ / |  __/ | (_| | | | | | |\ \| | (_| |  __/
    // \____/ \__,_|_| |_|\__\__,_| |___/ \____/|_|\___|_|\__, |_| |_| \_| \_|_|\__,_|\___|
    //                                                     __/ |
    //                                                    |___/
    var ssrGridSize = 60,
        ssrGridStep = $('.ssr-container').width() / ssrGridSize,
        ssrAvatars  = [];

    socket
    .on('santassleighride init', function (teams, avatars, scores, leaders) {
        nukeTimer();
        resetScreen();

        ssrAvatars = avatars;

        for (var t in teams) {
            var playerDiv = $('.ssr-player[data-player='+(parseInt(t)+1)+']');
            $('.ssr-name', playerDiv).html(teams[t]);

            if (avatars[t]) {
                $('.ssr-avatar', playerDiv).css({"background-image" : "url(" + ssrAvatars[t] + ")"});
            }

            if (leaders[t]) {
                $('.ssr-crown', playerDiv).show();
            } else {
                $('.ssr-crown', playerDiv).hide();
            }

            $(playerDiv).show();

            $(playerDiv).animate({left: (parseInt(scores[t]) * ssrGridStep) + "px"}, 500);
        }

        $('section').hide();
        $('#ssr').show();
        $('#ssr-stage').show();
        $('#ssr-help').show();
        $('#ssr-timer').hide();
        $('#ssr-q').css({top: "1200px"}).show();

        $('.ssr-answers').each(function() {
            $(this).html("&nbsp;");
        });
    })
    .on('santassleighride active', function (question) {
        $('#ssr-help').hide();

        $('.ssr-answers').each(function() {
            $(this).html("&nbsp;");
        });

        $('#ssr-q .ssr-question h1').html(question.title);
        var answers = $('#ssr-q .ssr-question ul.ssr-answers');
        answers.empty();
        var qno = 1;
        for (var q in question.answers) {
            answers.append('<li>' + (qno++) + ':' + q + '</li>');
        }
        $('#ssr-q').animate({top: "250px"});
        $('#ssr-timer').html("10").show();
    })
    .on('santassleighride tick', function (tVal) {
        $('#ssr-timer').html(tVal);
        if (tVal < 6) {
            $('#timer_tick')[0].play();
        }
    })
    .on('santassleighride roundend', function (question) {
        $('#ssr-timer').hide().html(10);

        var answers = $('#ssr-q .ssr-question ul.ssr-answers');
        answers.empty();
        var qno = 1;
        for (var q in question.answers) {
            var correct = question.answers[q]; ;
            answers.append('<li class="ssr-' + (correct ? 'true' : 'false') + '">' +
                (correct ? '' : '<strike>') +
                (qno++) + ':' + q +
                (correct ? '' : '</strike>') +
            '</li>');
        }
    })
    .on('santassleighride answers', async function (answers, scores, leaders, winners) {
        await delay(5);

        $('#ssr-q').animate({top: "1200px"});

        var correct = "✅", wrong = "❌", anyMoved = false;
        for (var a in answers) {
            var playerDiv = $('.ssr-player[data-player='+(parseInt(a)+1)+']');
            var aStr = '';
            for (var qa = 0; qa < answers[a].length; ++qa) {
                aStr += answers[a][qa] ? correct : wrong;

                if (answers[a][qa]) {
                    anyMoved = true;
                }
            }
            $('.ssr-answers', playerDiv).html(aStr);
        }

        await delay(2);

        if (anyMoved) {
            $('#wind')[0].play();
        }

        for (var t in scores) {
            var playerDiv = $('.ssr-player[data-player='+(parseInt(t)+1)+']');
            $(playerDiv).animate({left: (parseInt(scores[t]) * ssrGridStep) + "px"}, 1000);
            if (leaders[t]) {
                $('.ssr-crown', playerDiv).show();
            } else {
                $('.ssr-crown', playerDiv).hide();
            }
        }

        if (winners.length) {
            await delay(2);
            ssrShowEndScreen(winners);
        }
    });

    function ssrShowEndScreen(winners) {
        $('.ssr-player').each(function () { $(this).hide(); });
        $('#ssr-timer').hide();
        $('#ssr-q').hide();
        $('#ssr-help').hide();
        $('#ssr-stage').hide();

        $('#ssr-end').show();
        $('#ssr-winner-container').html('');

        for (var w in winners) {
            var t = winners[w];

            var av = $('<div class="ssr-winner-avatar">'),
                tn = $('.ssr-name', '.ssr-player[data-player='+(parseInt(t)+1)+']').html();

                if (ssrAvatars[t]) {
                    av.css({"background-image" : "url(" + ssrAvatars[t] + ")"});
                }

            var wincard = $('<div class="ssr-winner" />')
                .append(av)
                .append('<div class="ssr-winner-name">'+tn+'</div>');

            $('#ssr-winner-container').append(wincard);
        }

        $('.ssr-winner').each(function () {
            $(this).fadeIn(1000);
        });

        $('#cheer')[0].play();
    }
});
