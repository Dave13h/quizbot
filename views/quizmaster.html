<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>Quiz Master</title>

        <link href="css/nes.min.css" rel="stylesheet" />
        <link href="css/animate.css" rel="stylesheet" />
        <link href="css/style.css" rel="stylesheet" />

        <style>
            #questions_view, #teams_view, #sounds_view, #game_view, #titles_view { display: none; }

            #game_actions { display: none; }

            span.played { color: #aaa; }

            .teamname { width: 200px; }
            .teamscore { width: 100px; }

            .containers {
                /* mmm hack for too many questions in list */
                background-color: #00b5cc;
            }
            #questions { font-size: 80%; }
            #questions .btn { padding: 5px 6px; }
            #questions div { margin-bottom: 20px; border: 1px solid #fff; }
        </style>
    </head>
    <body>
        <h1>Quiz Master</h1>

        <section class="container with-title">
            <h2 class="title">Modes</h2>
            <div id="menu">
                <button type="button" data-target="contestants" class="btn is-primary">Contestants</button>
                <button type="button" data-target="teams" class="btn is-success">Teams</button>
                <button type="button" data-target="questions" class="btn is-success">Questions</button>
                <button type="button" data-target="sounds" class="btn is-success">Sounds</button>
                <button type="button" data-target="titles" class="btn is-success">Titles</button>
                <button type="button" data-target="game" class="btn is-success">Game</button>
            </div>
        </section>

        <section class="container with-title" id="contestants_view">
            <h2 class="title">Contestants</h2>
            <div class="containers" id="contestants"></div>
        </section>

        <section class="container with-title" id="teams_view">
            <h2 class="title">Teams</h2>
            <div class="containers" id="teams"></div>
        </section>

        <section class="container with-title" id="questions_view">
            <h2 class="title">Questions</h2>
            <div class="containers" id="questions"></div>
        </section>

        <section class="container with-title" id="sounds_view">
            <h2 class="title">Sounds</h2>
            <div class="containers" id="sounds">
                <button type="button" data-sound="awesome" class="btn">Awesome</button>
                <button type="button" data-sound="nextround" class="btn">Next round</button>
                <button type="button" data-sound="notyourbestmoment" class="btn">Not your best moment</button>
                <button type="button" data-sound="orderorder" class="btn">Order! Order!</button>
                <button type="button" data-sound="nice_to_see_you" class="btn">Nice to see you</button>
                <button type="button" data-sound="catchphrase" class="btn">Catchphrase</button>
                <button type="button" data-sound="weakest_link" class="btn">Weakest Link</button>

                <br><br>
                <button type="button" id="stopaudio" class="btn is-error">Stop all audio</button>
            </div>
        </section>

        <section class="container with-title" id="titles_view">
            <h2 class="title">titles</h2>
            <div class="containers" id="titles">
                <button type="button" data-title="wait" class="btn">Wait</button>
                <button type="button" data-title="intro" data-audio="music_intro" class="btn">Intro</button>
                <button type="button" data-title="scores" class="btn">Scores</button>
                <button type="button" data-title="break" class="btn">Break the game</button>
                <button type="button" data-title="outro" data-audio="music_outro" class="btn">Outro</button>
            </div>
        </section>

        <section class="container with-title" id="game_view">
            <h2 class="title">Game</h2>
            <div class="containers" id="game">
                <h3>Active Question</h3>
                <p id="active_question"> -- None -- </p>

                <h3>Active Team</h3>
                <p id="active_team"> -- None -- </p>

                <button type="button" id="game_skip" class="btn is-warning">Skip</button><br>
                <button type="button" id="game_audio" class="btn is-success" style="display: none;">Play Audio</button><br>

                <button type="button" id="game_timer_start" class="btn is-success" style="display: none;">Start timer</button>
                <button type="button" id="game_timer_pause" class="btn is-warning" style="display: none;">Pause timer</button>
                <button type="button" id="game_timer_reset" class="btn is-error" style="display: none;">Reset timer</button>

                <div id="game_actions">
                    <button type="button" id="game_correct" class="btn is-primary">Correct</button>
                    <button type="button" id="game_wrong" class="btn is-error">Wrong</button>
                </div>
            </div>
        </section>

        <script src="/socket.io/socket.io.js"></script>
        <script src="js/jquery-1.11.1.js"></script>
        <script>
          $(function () {
                function rot13(s) {
                    return s.replace(/[a-zA-Z]/g, function (c) {
                        return String.fromCharCode((c <= 'Z' ? 90 : 122) >= (c = c.charCodeAt(0) + 13) ? c : c - 26);
                    });
                }
                var awesomeAuth = rot13(prompt('password?'));
                var pass = 'cnffjbeq1'
                if (awesomeAuth != pass) {
                    window.location.reload(false);
                }

                function selectView () {
                    if (!$(this).data('target'))
                        return;

                    $('#menu button').each(function() {
                        $('#' + $(this).data('target') + '_view').hide();
                        $(this).removeClass('is-primary').addClass('is-success');
                    });
                    $('#' + $(this).data('target') + '_view').show();
                    $(this).removeClass('is-success').addClass('is-primary');
                }

                var socket = io.connect('/quizmaster'),
                    qmid   = window.localStorage.getItem('qmid');

                socket
                .on('connections list', function(contestants){
                    $('#contestants').html('');
                    if (contestants.length == 0) {
                        $('#contestants').append("-- No Contestants --");
                        return;
                    }
                    $(contestants).each(function(k, v) {
                        var disconnect = $('<button/>')
                            .addClass('btn')
                            .addClass('is-error')
                            .html('<i class="icon close"></i>')
                            .on('click', function() {
                                socket.emit('client forcedisconnect', v.cid);
                            })
                        var con = v.str + "<br/>";
                        $('#contestants').append(disconnect);
                        $('#contestants').append(con);
                    });
                })
                .on('teams list', function(teams){
                    $('#teams').html('');
                    if (teams.length == 0) {
                        $('#teams').append("-- No Teams --");
                        return;
                    }
                    $(teams).each(function(k, v) {
                        let teamName = '<input type="text" class="input teamname" data-tid="' + k +
                            '" style="display: inline-block" value="' + v.name + '" />';

                        let teamPoints = '<input type="text" class="input teamscore" data-tid="' + k +
                            '" style="display: inline-block" value="' + v.points + '" />';
                        let t = teamName + " => Points: " + teamPoints + " Answered: " + v.answered + "<br/>";
                        $('#teams').append(t);
                    });

                    $('.teamname').on('focusout', function() {
                        socket.emit('team name', { id: $(this).data('tid'), name: $(this).val() });
                    });
                    $('.teamscore').on('focusout', function() {
                        socket.emit('team score', { id: $(this).data('tid'), points: $(this).val() });
                    });
                })
                .on('questions list', function(questions){
                    $('#questions').html('');
                    if (questions.length == 0) {
                        $('#questions').append("-- No Questions --");
                        return;
                    }
                    $(questions).each(function(k, v) {
                        let bClass = 'is-primary',
                            bIcon  = 'star';
                        if (v.played) {
                            bClass = '';
                            bIcon = 'star is-empty';
                        }
                        let con = $('<div/>');
                        let play = $('<button/>')
                            .addClass('btn')
                            .addClass(bClass)
                            .html('<i class="icon ' + bIcon + '"></i>')
                            .on('click', function() {
                                socket.emit('question play', k);
                                $('#active_question').html(v.text);
                                $('#active_team').html(' -- None -- ');
                                $('#game_actions').hide();
                                $('#game_audio').hide();
                                $('button[data-target="game"]').click();

                                $('#game_audio').hide();
                                $('#game_timer_start').hide();
                                $('#game_timer_pause').hide();
                                $('#game_timer_reset').hide();

                                if (v.type == 'audio') {
                                    $('#game_audio').show();
                                } else if (v.type == 'timer') {
                                    $('#game_timer_start').show();
                                    $('#game_timer_pause').show();
                                    $('#game_timer_reset').show();
                                }
                            })
                        let line = $('<span/>').html("[" + v.type + "] " + v.title + "<br/>" + v.text);
                        if (v.played)
                            line.addClass('played');

                        $(con).append(play).append(line);

                        $('#questions').append(con);
                    });
                })
                .on('question buzzed', function(msg) {
                    $('#active_team').html(msg.team.name);
                    $('#game_actions').show();
                })
                .on('game state', function(state) {
                    $('#game_audio').hide();

                    $('#active_question').html(' -- None -- ');

                    if (state.question) {
                        $('#active_question').html(state.question.text);

                        if (state.question.type == 'audio') {
                            $('#game_audio').show();
                        } else if (state.question.type == 'timer') {
                            $('#game_timer_start').show();
                            $('#game_timer_pause').show();
                            $('#game_timer_reset').show();
                        }
                    }

                    $('#active_team').html(' -- None -- ');
                    if (state.team)
                        $('#active_team').html(state.team.name);

                    $('#game_actions').show();
                })
                .on('reconnect', function(msg) {
                    socket.emit('ident', qmid);
                    console.log("Reconnected");
                })
                .on('connect', function(msg) {
                    socket.emit('ident', qmid);
                    console.log("Connected");
                })
                .on('id', function(id){
                    console.log('Got ID: ' + id);
                    qmid = id;
                    window.localStorage.setItem('qmid', qmid);
                });

                $('#menu button').on('click', selectView);
                $('#stopaudio').on('click', function() {
                    socket.emit('sound stop');
                });

                $('#game_audio').on('click', function() {
                    socket.emit('question audio play');
                });

                $('#game_timer_start').on('click', function() {
                    socket.emit('question timer', {action: 'start'});
                });
                $('#game_timer_pause').on('click', function() {
                    socket.emit('question timer', {action: 'pause'});
                });
                $('#game_timer_reset').on('click', function() {
                    socket.emit('question timer', {action: 'reset'});
                });

                $('#game_correct').on('click', function() {
                    socket.emit('question correct');
                    $('#game_actions').hide();

                    $('#active_question').html(' -- None -- ');
                    $('#active_team').html(' -- None -- ');
                    $('button[data-target="teams"]').click();
                });
                $('#game_wrong').on('click', function() {
                    socket.emit('question wrong');
                    $('#game_actions').hide();
                    $('#active_team').html(' -- None -- ');
                });

                $('#game_skip').on('click', function() {
                    socket.emit('question skip');
                    $('#game_actions').hide();

                    $('#active_question').html(' -- None -- ');
                    $('#active_team').html(' -- None -- ');
                    $('button[data-target="teams"]').click();
                });

                $('#sounds button').on('click', function() {
                    socket.emit('sound play', $(this).data('sound'));
                });

                $('#titles button').on('click', function() {
                    var title = {title: $(this).data('title'), audio: null};
                    if ($(this).data('audio')) {
                        title.audio = $(this).data('audio');
                    }
                    socket.emit('title show', title);
                });
            });
        </script>
    </body>
</html>
