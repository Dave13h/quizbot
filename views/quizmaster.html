<!doctype html>
<!--
______ ___________  __   __                      _____       _
|  _  \____ | ___ \ \ \ / /                     |  _  |     (_)
| | | |   / / |_/ /  \ V / _ __ ___   __ _ ___  | | | |_   _ _ ____
| | | |   \ \    /   /   \| '_ ` _ \ / _` / __| | | | | | | | |_  /
| |/ /.___/ / |\ \  / /^\ \ | | | | | (_| \__ \ \ \/' / |_| | |/ /
|___/ \____/\_| \_| \/   \/_| |_| |_|\__,_|___/  \_/\_\\__,_|_/___|


Hello mr adventurous person, are you looking for holes in this application to exploit?

Well you are in luck! There is at least one security flaw (that I know of)
in this interface you just need to try your luck.

Whilst on your way down this abomination of a html file please refrain for judging the
horrific crimes against CSS and HTML, I do not claim to be a Front End developer and
there was little planning involved in the making of this and just like any good developer
I threw this all together in a complete rush and bodged it until it works.

Have I managed to distract you from actually finding the flaw in this enough? you are
burning precious time reading this nonsense rather than trying to break the system and
change your score eh? It' kind of reminds me of that time in 1998, The Undertaker threw
Mankind off Hell In A Cell, and plummeted 16 ft through an announcer's table.

The first bump Foley would take came as both wrestlers were brawling on top of the cell,
and the Undertaker threw Mankind from the top of the cage from a height of 16 feet (4.9 m);
(22 ft if including angle of the fall)[8] and sent him crashing through the Spanish
announcers' table, which triggered announcer Jim Ross to famously shout,
"Good God almighty! Good God almighty! That killed him! As God as my witness,
he is broken in half!

Clock is ticking by the way ;)

Seriously, you will want to look a lot further down.. *hint* the fun things happen in
the javascript section ;)

While I have you all here, anyone fancy contributing to this project for next year?
This seriously needs some cleaning up and it would be nice to try and polish this up
just a tad so that its not such a cobbled together hash of game code :P

https://github.com/Dave13h/QuizBot - if its not public, shoot me a message.

Enjoy

-- Dave, the resident code bodger.

-->
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>Quiz Master</title>

        <link href="css/nes.min.css" rel="stylesheet" />
        <link href="css/animate.css" rel="stylesheet" />
        <link href="css/style.css" rel="stylesheet" />

        <!-- you would have thought I would have moved this into a separate file by now eh? -->
        <style>
            #questions_view, #teams_view, #sounds_view, #game_view, #titles_view, #debug_view { display: none; }

            #game_actions { display: none; }

            span.played { color: #aaa; }

            .teamname { width: 200px; }
            .teamscore { width: 100px; }

            .containers {
                /* mmm hack for too many questions in list */
                background-color: #00b5cc;
            }
            #questions { font-size: 80%; }
            #questions .btn { padding: 5px 6px; }
            #questions div { margin-bottom: 20px; border: 1px solid #fff; }

            .canvas {
                background-color: #fff;
                border: 2px solid #000;
                height: 800px;
                width: 800px;
            }

            .toggle_image {
                height: 5%;
                width: 5%;
            }
            .toggle_image:hover {
                height: 25%;
                width: 25%;
            }

            #game_pictionary ul li.active {
                font-weight: bold;
                color: #FF9;
            }
            #game_pictionary ul li.active:after {
                content: " <=="
            }
            #game_pictionary ul li.correct {
                color: #9F9;
            }
            #game_pictionary ul li.correct:after {
                content: " - Correct!"
            }
            #game_pictionary ul li.skip {
                color: #F99;
            }
            #game_pictionary ul li.skip:after {
                content: " - Skipped!"
            }

            body.curtain {
                display:none;
            }

            .headerbar {
                display: flex;
            }
            .headerbar div {
                flex-basis: 50%;
                height: 48px;
                margin: 5px;
                vertical-align: center;
            }
        </style>
    </head>
    <body class="curtain">
        <div class="headerbar">
            <div>
                <h1>Quiz Master</h1>
            </div>
            <div style="text-align: right;line-height: 48px;">
                <label>
                    <input id="autosave" type="checkbox" class="nes-checkbox" value="1">
                    <span>AutoSave</span>
                </label>
            </div>
        </div>

        <section class="container with-title">
            <h2 class="title">Modes</h2>
            <div id="menu">
                <button type="button" data-target="contestants" class="btn is-primary">Contestants</button>
                <button type="button" data-target="teams" class="btn is-success">Teams</button>
                <button type="button" data-target="questions" class="btn is-success">Questions</button>
                <button type="button" data-target="sounds" class="btn is-success">Sounds</button>
                <button type="button" data-target="titles" class="btn is-success">Titles</button>
                <button type="button" data-target="game" class="btn is-success">Game</button>
                <button type="button" data-target="debug" class="btn is-success">Debug</button>
            </div>
        </section>

        <section class="container with-title" id="contestants_view">
            <h2 class="title">Contestants</h2>
            <div class="containers" id="contestants"></div>
        </section>

        <section class="container with-title" id="teams_view">
            <h2 class="title">Teams</h2>
            <div class="containers" id="teams"></div>
        </section>

        <section class="container with-title" id="questions_view">
            <h2 class="title">Questions</h2>
            <div class="containers" id="questions"></div>
        </section>

        <section class="container with-title" id="sounds_view">
            <h2 class="title">Sounds</h2>
            <div class="containers" id="sounds">
                <button type="button" data-sound="awesome" class="btn">Awesome</button>
                <button type="button" data-sound="nextround" class="btn">Next round</button>
                <button type="button" data-sound="notyourbestmoment" class="btn">Not your best moment</button>
                <button type="button" data-sound="orderorder" class="btn">Order! Order!</button>
                <button type="button" data-sound="nice_to_see_you" class="btn">Nice to see you</button>
                <button type="button" data-sound="catchphrase" class="btn">Catchphrase</button>
                <button type="button" data-sound="weakest_link" class="btn">Weakest Link</button>
                <button type="button" data-sound="im_in_charge" class="btn">I'm in charge</button>

                <br><br>
                <button type="button" id="stopaudio" class="btn is-error">Stop all audio</button>
            </div>
        </section>

        <section class="container with-title" id="titles_view">
            <h2 class="title">titles</h2>
            <div class="containers" id="titles">
                <button type="button" data-title="wait" class="btn">Wait</button>
                <button type="button" data-title="intro" data-audio="music_intro" class="btn">Intro</button>
                <button type="button" data-title="teams" class="btn">Teams</button>
                <button type="button" data-title="rules" class="btn">Rules</button>
                <button type="button" data-title="rounds" class="btn">Rounds</button>
                <button type="button" data-title="scores" class="btn">Scores</button>
                <button type="button" data-title="break" class="btn">Break the game</button>
                <button type="button" data-title="outro" data-audio="music_outro" class="btn">Outro</button>
            </div>
        </section>

        <section class="container with-title" id="game_view">
            <h2 class="title">Game</h2>
            <div class="containers" id="game">
                <div id="active_state">
                    <h3>Active Question</h3>
                    <p id="active_question"> -- None -- </p>

                    <h3>Active Team</h3>
                    <p id="active_team"> -- None -- </p>
                </div>

                <button type="button" id="game_skip" class="btn is-warning">Skip</button><br>
                <button type="button" id="game_audio" class="btn is-success" style="display: none;">Play Audio</button>

                <div id="game_pictionary">
                    Pictures<br />
                    <ul></ul><br />

                    <button type="button" id="game_pictionary_start" class="btn is-success">Start</button>
                    <button type="button" id="game_pictionary_correct" class="btn is-primary">Correct</button>
                    <button type="button" id="game_pictionary_skip" class="btn is-warning">Skip</button>
                    <button type="button" id="game_pictionary_end" class="btn is-error">End</button><br />
                </div>

                <br />
                <button type="button" id="game_timer_start" class="btn is-success" style="display: none;">Start timer</button>
                <button type="button" id="game_timer_pause" class="btn is-warning" style="display: none;">Pause timer</button>
                <button type="button" id="game_timer_reset" class="btn is-error" style="display: none;">Reset timer</button>

                <div id="game_actions">
                    <button type="button" id="game_correct" class="btn is-primary">Correct</button>
                    <button type="button" id="game_wrong" class="btn is-error">Wrong</button>
                </div>
            </div>
        </section>

        <section class="container with-title" id="debug_view">
            <h2 class="title">Debug</h2>
            <button type="button" id="fetch_debug_teams" class="btn is-warning">Debug Teams</button>
            <div class="containers" id="debug"></div>
        </section>

        <!--
            totally legit javascript section,
            keep going sir, you've survived the html section.
            You are doing great! Don't let anyone ever tell you otherwise.
        -->
        <script src="/socket.io/socket.io.js"></script>
        <script src="js/jquery-1.11.1.js"></script>
        <script>
          $(function () {
                /**
                 * Docblock... nah just kidding
                 * @author Responsable Developer <dev@d3r.com>
                 */
                function selectView () {
                    if (!$(this).data('target'))
                        return;

                    $('#menu button').each(function() {
                        $('#' + $(this).data('target') + '_view').hide();
                        $(this).removeClass('is-primary').addClass('is-success');
                    });
                    $('#' + $(this).data('target') + '_view').show();
                    $(this).removeClass('is-success').addClass('is-primary');
                }

                var pin    = prompt("Enter Pin"), // this looks interesting right?
                    socket = io.connect('/quizmaster'), // This MUST be important... its a socket!
                    qmid   = window.localStorage.getItem('qmid'); // ooh could be exploitable right?

                socket
                .on('connections list', function(contestants){
                    $('#contestants').html('');
                    if (contestants.length == 0) {
                        $('#contestants').append("-- No Contestants --");
                        return;
                    }
                    $(contestants).each(function(k, v) {
                        var disconnect = $('<button/>')
                            .addClass('btn')
                            .addClass('is-error')
                            .html('<i class="icon close"></i>')
                            .on('click', function() {
                                // Kill the other player... or don't it's your life, I can't tell you what to do.
                                socket.emit('client forcedisconnect', v.cid);
                            })
                        var con = v.str + "<br/>";
                        $('#contestants').append(disconnect);
                        $('#contestants').append(con);
                    });
                })
                .on('teams list', function(teams){
                    $('#teams').html('');
                    if (teams.length == 0) {
                        $('#teams').append("-- No Teams --");
                        return;
                    }
                    $('.teampenalty').off('click');
                    $(teams).each(function(k, v) {
                        let teamName = '<input type="text" class="input teamname" data-tid="' + k +
                            '" style="display: inline-block" value="' + v.name + '" />';

                        // I feel like this should have constructed using a Jquery object, I'm sure
                        // I had my reasons. It does make the code messier at least so you'll likely
                        // waste your time reading this rahter than finding the exploit?
                        // Yeah lets go with that, just to be slightly helpful, no the exploit isn't
                        // in the next few lines :P
                        // But I guess you could do something with the data-tid field right?
                        // oh crap, did I remember to bounds check the team id lookup in the backend? :thinking:
                        let teamPoints = '<input type="text" class="input teamscore" data-tid="' + k +
                            '" style="display: inline-block" value="' + v.points + '" />';
                        let t = teamName + " => Points: " + teamPoints +
                            '<button class="teampenalty btn btn-sm is-error" data-tid="' + k +
                                '" title="issue a penality -1 point">P</button>' +
                            " Answered: " + v.answered +
                            "<br/>";
                        $('#teams').append(t);
                    });

//
// Mmm distraction cake...
//           )
//          (.)
//          .|.
//          l8J
//          | |
//      _.--| |--._
//   .-';  ;`-'& ; `&.
//  & &  ;  &   ; ;   \
//  \      ;    &   &_/
//   F"""---...---"""J
//   | | | | | | | | |
//   J | | | | | | | F
//    `---.|.|.|.---'
//       ... I hope you aren't using Tabs for indenting ;)
//

                    $('.teampenalty').on('click', function() {
                        console.log($(this).data('tid'));
                        var $team = $('.teamscore[data-tid=' + $(this).data('tid') + ']');
                        console.log($team.val());
                        $team.val(parseInt($team.val()) - 1);

                        // Oooh look at this! the Quizmaster can manipulate the scores using this callback!
                        // What could this possibly mean?
                        socket.emit('team score', { id: $(this).data('tid'), points: parseInt($team.val()), penalty: true});
                    });

                    $('.teamname').on('focusout', function() {
                        socket.emit('team name', { id: $(this).data('tid'), name: parseInt($(this).val()) });
                    });
                    $('.teamscore').on('focusout', function() {
                        socket.emit('team score', { id: $(this).data('tid'), points: parseInt($(this).val()) });
                    });
                })
                .on('debug teams', function(debugData) {
                    $('#debug').html('');
                    $(debugData.teams).each(function(k, v) {
                        let teamName = '<h2>' + v.name + '</h2>';
                        $('#debug').append(teamName);

                        if (v.logo) {
                            $('#debug').append('Logo<br/>');
                            let limg = new Image();
                            limg.src = v.logo;
                            $('#debug').append($('<br/><div />').html(limg));
                        }

                        if (v.avatar) {
                            $('#debug').append('Avatar<br/>');
                            let aimg = new Image();
                            aimg.src = v.avatar;
                            $('#debug').append($('<br/><div />').html(aimg));
                        }

                        $('#debug').append('Buzzer: ' + (v.buzzer ? 'yes' : 'no') + '<br/><hr/>');
                    });
                })
                .on('questions list', function(questions){
                    $('#questions').html('');
                    if (questions.length == 0) {
                        $('#questions').append("-- No Questions --");
                        return;
                    }
                    $(questions).each(function(k, v) {
                        let bClass = 'is-primary',
                            bIcon  = 'star';
                        if (v.played) {
                            bClass = '';
                            bIcon = 'star is-empty';
                        }
                        let con = $('<div/>');
                        let play = $('<button/>')
                            .addClass('btn')
                            .addClass(bClass)
                            .html('<i class="icon ' + bIcon + '"></i>')
                            .on('click', function() {
                                socket.emit('question play', k);
                                $('#active_question').html(v.text);
                                $('#active_team').html(' -- None -- ');
                                $('#active_state').show();

                                $('#game_actions').hide();
                                $('#game_audio').hide();
                                $('button[data-target="game"]').click();

                                // This could have been a single command really, meh 'organic' code :P
                                $('#game_audio').hide();
                                $('#game_timer_start').hide();
                                $('#game_timer_pause').hide();
                                $('#game_timer_reset').hide();

                                $('#game_skip').show();

                                $('#game_pictionary').hide();
                                $('#game_pictionary_end').hide();
                                $('#game_pictionary_start').hide();
                                $('#game_pictionary_correct').hide();
                                $('#game_pictionary_skip').hide();

                                if (v.type == 'audio') {
                                    $('#game_audio').show();
                                } else if (v.type == 'timer' || v.type == 'catchphrase' || v.type == 'pictionary') {
                                    $('#game_timer_start').show();
                                    $('#game_timer_pause').show();
                                    $('#game_timer_reset').show();
                                }

                                // #noshame
                                if (v.type == 'pictionary') {
                                    $('#active_state').hide();
                                    $('#game_actions').hide();
                                    $('#game_skip').hide();
                                    $('#game_pictionary').show();
                                    $('#game_pictionary_start').show();
                                }
                            })

                        let lineStr = "[" + v.type + "] " + v.title + "<br/>";
                        switch (v.type) {
                            case 'catchphrase':
                                lineStr += '<img class="toggle_image" src="/images/' + v.image + '">';
                                break;

                            case 'pictionary':
                                break;

                            default:
                                lineStr += v.text;
                                break;
                        }
                        let line = $('<span/>').html(lineStr);

                        if (v.played)
                            line.addClass('played');

                        $(con).append(play).append(line);

                        $('#questions').append(con);
                    });
                })
                .on('question buzzed', function(msg) {
                    $('#active_team').html(msg.team.name);
                    $('#game_actions').show();
                })
                .on('pictionary init', function(questions) {
                    $('#game_pictionary ul').empty();
                    for (var pq in questions) {
                        $('#game_pictionary ul').append(
                            $('<li/>').attr('data-qid', pq).html(questions[pq])
                        );
                    }
                    $('#game_pictionary ul li').removeClass('active');
                    $('#game_pictionary ul li[data-qid=0]').addClass('active');
                    $('#game_pictionary_start').show();
                    $('#game_timer_start').hide();
                    $('#game_timer_pause').hide();
                    $('#game_timer_reset').hide();
                })
                .on('pictionary active', function(activeQ) {
                    $('#game_pictionary ul li').removeClass('active');
                    $('#game_pictionary ul li[data-qid=' + activeQ + ']').addClass('active');
                })
                .on('pictionary end', function(activeQ) {
                    $('#game_pictionary_correct').hide();
                    $('#game_pictionary_skip').hide();
                })

                // The game state eh? obviously comes from the server, how can we trick it?
                // Does the /dashboard use this too? oops, did I just leak the endpoint for the dashboard?
                // Nothing exploitable there at all is there?
                .on('game state', function(state) {
                    if ($('body').hasClass('curtain')) {
                        $('body').removeClass('curtain');
                    }
                    $('#game_audio').hide();

                    $('#active_question').html(' -- None -- ');

                    if (state.question) {
                        $('#active_question').html(state.question.text);
                        $('#active_state').show();

                        $('#game_skip').show();
                        $('#game_actions').hide();

                        // There must be some important bits missing here, suspiciously like the
                        // questions list routine but much less code. I'm sure a peer review would
                        // have spotted this.
                        $('#game_pictionary').hide();
                        $('#game_pictionary_end').hide();
                        $('#game_pictionary_skip').hide();

                        if (state.question.type == 'audio') {
                            $('#game_audio').show();
                        } else if (state.question.type == 'timer' ||
                            state.question.type == 'catchphrase' ||
                            state.question.type == 'pictionary'
                        ) {
                            $('#game_timer_start').show();
                            $('#game_timer_pause').show();
                            $('#game_timer_reset').show();
                        }

                        if (state.question.type == 'pictionary') {
                            $('#active_state').hide();
                            $('#game_actions').hide();
                            $('#game_pictionary').show();
                            $('#game_skip').hide();
                            $('#game_pictionary_start').show();
                        }
                    }

                    $('#active_team').html(' -- None -- ');
                    if (state.team)
                        $('#active_team').html(state.team.name);

                    $('#game_actions').show();
                })
                .on('reconnect', function(msg) {
                    socket.emit('ident', pin, qmid); // Whoa... the pin is in plain text IN THE PAGE?!
                                                     // Is that important?
                    console.log("Reconnected", ret);
                })
                .on('connect', function(msg) {
                    // Hmm, we 'ident' using the 'pin'. Interesting, what could that possibly mean?
                    socket.emit('ident', pin, qmid);
                    console.log("Connected");
                })
                .on('bad auth', function(msg) {
                    var c = confirm("bad pin"); // Bad pin, reload the page?
                    window.location.reload(false);
                })
                .on('id', function(id){
                    console.log('Got ID: ' + id);
                    qmid = id;
                    window.localStorage.setItem('qmid', qmid); // Careless or Carefree?
                })
                .on('canvas pen', function(data){
                    // Interesting tidbit.. sending the entire canvas over to the server each time there
                    // is a change is B-RU-TAL! Good way to DOS your node server, so we just send the changes
                    // as they happen, the receiver of the event just simulates the same draw call that comes
                    // over from the client.
                    //
                    // Even more interesting is that this routine isn't even used on the quizmaster side.
                    //
                    // Its just left over from the proof of concept and I've only literally just realised
                    // I left this in here as I am typing this comment *sips coffee*
                    canvasCtx.beginPath();
                        canvasCtx.moveTo(data.x1, data.y1);
                        canvasCtx.lineTo(data.x2, data.y2);
                        canvasCtx.strokeStyle = data.c;
                        canvasCtx.lineWidth = data.s;
                        canvasCtx.stroke();
                    canvasCtx.closePath();
                })
                .on('canvas clear', function(data){
                    canvasCtx.clearRect(0, 0, canvasW, canvasH);
                })
                .on('canvas fill', function(data){
                    canvasCtx.fillStyle = data.c;
                    canvasCtx.fillRect(0, 0, canvasW, canvasH);
                    canvasCtx.fillStyle = '#fff';
                })
                ;

                $('#menu button').on('click', selectView);
                $('#stopaudio').on('click', function() {
                    socket.emit('sound stop');
                });

                $('#game_audio').on('click', function() {
                    socket.emit('question audio play');
                });

                $('#game_timer_start').on('click', function() {
                    socket.emit('question timer', {action: 'start'});
                });
                $('#game_timer_pause').on('click', function() {
                    socket.emit('question timer', {action: 'pause'});
                });
                $('#game_timer_reset').on('click', function() {
                    socket.emit('question timer', {action: 'reset'});
                });
                $('#autosave').on('click', function() {
                    socket.emit('autosave', $(this).is(':checked'));
                });

                $('#fetch_debug_teams').on('click', function() {
                    socket.emit('debug teams');
                });

                // Are you sure you want to be all the way down here? Don't think there is anything useful here
                $('#game_correct').on('click', function() {
                    socket.emit('question correct');
                    $('#game_actions').hide();

                    $('#active_question').html(' -- None -- ');
                    $('#active_team').html(' -- None -- ');
                    $('button[data-target="teams"]').click();
                });
                $('#game_wrong').on('click', function() {
                    socket.emit('question wrong');
                    $('#game_actions').hide();
                    $('#active_team').html(' -- None -- ');
                });

                $('#game_skip').on('click', function() {
                    socket.emit('question skip');
                    $('#game_actions').hide();

                    $('#active_question').html(' -- None -- ');
                    $('#active_team').html(' -- None -- ');
                    $('button[data-target="teams"]').click();
                });

                // Pictionary bits, yeah you can't break what is already broken. move along.
                $('#game_pictionary_start').on('click', function() {
                    $('#game_pictionary_start').hide();
                    $('#game_pictionary_correct').show();
                    $('#game_pictionary_skip').show();
                    socket.emit('pictionary start');
                });
                $('#game_pictionary_correct').on('click', function() {
                    $('#game_pictionary ul li.active').addClass('correct');
                    socket.emit('pictionary correct');
                });
                // Look at all these event handlers, its miraculous that this all even works tbh
                $('#game_pictionary_end').on('click', function() {
                    $('#game_pictionary_start').hide();
                    $('#game_pictionary_correct').hide();
                    $('#game_pictionary_skip').hide();
                    socket.emit('pictionary end');
                });
                $('#game_pictionary_skip').on('click', function() {
                    $('#game_pictionary ul li.active').addClass('skip');
                    socket.emit('pictionary skip');
                });

                $('#sounds button').on('click', function() {
                    socket.emit('sound play', $(this).data('sound'));
                });

                $('#titles button').on('click', function() {
                    var title = {title: $(this).data('title'), audio: null};
                    if ($(this).data('audio')) {
                        title.audio = $(this).data('audio');
                    }
                    socket.emit('title show', title);
                });


 // Well there you go, we are out of the valley javascript...
 //
 // Ahead of you is a stream...
 // Adventurer: [n,e,s,w,look,pickup,help]
 //                                  _
 //                        .-.      / \        _
 //            ^^         /   \    /^./\__   _/ \
 //          _        .--'\/\_ \__/.      \ /    \  ^^  ___
 //         / \_    _/ ^      \/  __  :'   /\/\  /\  __/   \
 //        /    \  /    .'   _/  /  \   ^ /    \/  \/ .`'\_/\
 //       /\/\  /\/ :' __  ^/  ^/    `--./.'  ^  `-.\ _    _:\ _
 //      /    \/  \  _/  \-' __/.' ^ _   \_   .'\   _/ \ .  __/ \
 //    /\  .-   `. \/     \ / -.   _/ \ -. `_/   \ /    `._/  ^  \
 //   /  `-.__ ^   / .-'.--'    . /    `--./ .-'  `-.  `-. `.  -  `.
 // @/        `.  / /      `-.   /  .-'   / .   .'   \    \  \  .-  \%
 // @(88%@)@%% @)&@&(88&@.-_=_-=_-=_-=_-=_.8@% &@&&8(8%@%8)(8@%8 8%@)%
 // @88:::&(&8&&8::JGS:&`.~-_~~-~~_~-~_~-~~=.'@(&%::::%@8&8)::&#@8::::
 // `::::::8%@@%:::::@%&8:`.=~~-.~~-.~~=..~'8::::::::&@8:::::&8::::::'
 //  `::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::'
 //                     "Thankfully no one got hurt."
 //                             - Some person in the news, probably

            });
        </script>
    </body>

    <!--

    Hope you all have a great Xmas and New Years! Good luck in 2023!
                                                            - Dave :)
    -->
</html>
