<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>Quiz Dashboard</title>

        <link href="css/nes.min.css" rel="stylesheet" />
        <link href="css/animate.css" rel="stylesheet" />
        <link href="css/style.css" rel="stylesheet" />

        <style>
            .fullscreen {
                text-align: center;
                position: absolute;
                top: 0;
                left: 0;
                height: 100%;
                width: 100%;
                box-shadow: inset 0 0 100px black;
                padding: 50px;
                background: url("images/tree.png") #384335 no-repeat bottom left;
                background-size: 540px auto;
            }

            #presskey {
                position: absolute;
                top: 0px;
                left: 0px;
                background-color: #a66;
                margin: 10px;
                border: 5px solid #777;
                text-align: center;
                padding-top: 10px;
                background-image: none;
            }

            #answer_correct, #answer_wrong, #answer_losers { display: none; }

            #question {
                display: none;
            }
            #question h1 {
                text-align: center;
                color: #fff;
                font-size: 200%;
            }

            #question div {
                margin-top: 25px;
                text-align: center;
                height: 100%;
                width: 100%;
            }

            #question .content {
                color: #fff;
                font-size: 250%;
            }

            #teamoverlay, #answer_correct, #answer_wrong, #answer_losers  {
                padding-top: 150px;
                display: none;
                font-size: 500%;
                background-color: rgba(100, 100, 100, 0.85);
                background-image: none;
            }

            #answer_correct {
                box-shadow: inset 0 0 100px #090;
                background-color: rgba(100, 150, 100, 0.85);
                color: #4f4;
            }
            #answer_wrong {
                box-shadow: inset 0 0 100px #900;
                background-color: rgba(150, 100, 100, 0.85);
                color: #f44;
            }
            #answer_losers {
                box-shadow: inset 0 0 100px #900;
                background-color: rgba(150, 125, 100, 0.85);
                color: #f44;
            }

            #teamoverlay {
                text-align: center;
                display: none;
            }

            #teamscores { display: none; text-align: center; color: #fff; }
            #teamscores h1 { font-size: 350%; }
            #teamscorelist .teamscorelist { font-size: 200%; }

            .title { display: none; }
            .title h1 { font-size: 350%; margin-bottom: 50px; }
            .title p { text-align: center; color: #fff; font-size: 200%; }

            .table {
                width: 100%;
                text-align: center;
                margin-left: auto;
                margin-right: auto;
            }
            .table th {
                background-color: #ccc;
                color: #000;
                border-left: 2px solid #fff;
                border-top: 2px solid #fff;
            }
            .table td {
                background-color: #999;
                color: #000;
                border-left: 2px solid #fff;
                border-top: 2px solid #fff;
                border-bottom: 2px solid #fff;
            }
            .table tr {
                border-right: 2px solid #fff;
            }

            .animated.delay-10s {
              -webkit-animation-delay: 10s;
              animation-delay: 10s;
            }

            .animated.delay-intro {
              -webkit-animation-delay: 80s;
              animation-delay: 80s;
            }

            .timer {
                font-size: 450%;
            }
        </style>
    </head>
    <body>
        <header>
            <h1 class="animated zoomInDown">D3R Xmas Charity Quiz 2018!</h1>
        </header>

        <div id="presskey">
            Press a key to enable audio
        </div>

        <section id="loading" class="loading">
            <div class="animated zoomInDown delay-1s">
                <p class="animated pulse infinite">Waiting for server</p>
            </div>
        </section>

        <section id="question" class="fullscreen"></section>

        <div style="display: none;">
            <img id="icon_music" class="animated zoomInDown delay-1s" src="images/icon_music.png" />
            <div id="timer" class="animated zoomInDown delay-1s timer"><span>60</span> seconds</div>
        </div>

        <section id="answer_correct" class="fullscreen">CORRECT!</section>
        <section id="answer_wrong" class="fullscreen">WRONG!</section>
        <section id="answer_losers" class="fullscreen">
            YOU ALL SUCK!<br>
            No one got the answer correct :(
        </section>

        <section id="teamoverlay" class="fullscreen"></section>
        <section id="teamscores" class="fullscreen">
            <h1 class="animated zoomInDown">Scores!</h1>
            <div id="teamscorelist"></div>
        </section>

        <!-- should all be loaded by the quiz system really -->
        <audio src="sounds/buzzer_default.wav" id="buzzer_default" preload></audio>
        <audio src="sounds/buzzer_wrong.wav" id="buzzer_wrong" preload></audio>
        <audio src="sounds/timer_tick.wav" id="timer_tick" preload></audio>
        <audio src="sounds/timer_horn.wav" id="timer_horn" preload></audio>
        <audio src="sounds/cheer.wav" id="cheer" preload></audio>
        <audio src="sounds/laugh.wav" id="laugh" preload></audio>

        <audio src="sounds/awesome.wav" id="awesome" preload></audio>
        <audio src="sounds/nextround.wav" id="nextround" preload></audio>
        <audio src="sounds/notyourbestmoment.wav" id="notyourbestmoment" preload></audio>
        <audio src="sounds/orderorder.wav" id="orderorder" preload></audio>
        <audio src="sounds/nice_to_see_you.wav" id="nice_to_see_you" preload></audio>
        <audio src="sounds/catchphrase.wav" id="catchphrase" preload></audio>
        <audio src="sounds/weakest_link.wav" id="weakest_link" preload></audio>

        <audio src="music/intro.wav" id="music_intro" preload></audio>
        <audio src="music/outro.wav" id="music_outro" preload></audio>

        <audio src="music/all_i_want_for_christmas.wav" id="music_all_i_want_for_christmas" preload></audio>
        <audio src="music/do_they_know_its_christmas.wav" id="music_do_they_know_its_christmas" preload></audio>
        <audio src="music/have_your_self_a_merry_little_christmas.wav" id="music_have_your_self_a_merry_little_christmas" preload></audio>
        <audio src="music/i_wish_it_could_be_christmas_everyday.wav" id="music_i_wish_it_could_be_christmas_everyday" preload></audio>
        <audio src="music/jingle_bells.wav" id="music_jingle_bells" preload></audio>
        <audio src="music/last_chistmas.wav" id="music_last_chistmas" preload></audio>
        <audio src="music/let_it_snow.wav" id="music_let_it_snow" preload></audio>
        <audio src="music/merry_christmas_everybody.wav" id="music_merry_christmas_everybody" preload></audio>
        <audio src="music/santa_claus_is_coming_to_town.wav" id="music_santa_claus_is_coming_to_town" preload></audio>
        <audio src="music/white_christmas.wav" id="music_white_christmas" preload></audio>

        <div id="title_wait" class="title fullscreen">
            <h1 class="animated zoomInDown">Welcome to the D3R Xmas Charity Quiz 2018</h1>
            <div class="animated zoomInDown delay-1s">
                <p class="animated pulse infinite">Please Wait</p>
            </div>
        </div>

        <div id="title_break" class="title fullscreen">
            <h1 class="animated zoomInDown">Hack the game and change your score to win!</h1>
            <div class="animated zoomInDown delay-1s">
                <p class="animated pulse infinite">
                    Sourcecode available at https://github.com/Dave13h/quizbot
                </p>
            </div>
        </div>

        <div id="title_outro" class="title fullscreen">
            <h1 class="animated zoomInDown">Final Scores!</h1>
            <div id="outroteams"></div>
        </div>

        <div id="title_intro" class="title fullscreen">
            <h1 class="animated zoomInDown">Welcome to the D3R Xmas Charity Quiz 2018</h1>
            <div class="animated zoomInDown delay-10s">
                <h2>Teams</h2>
                <table class="table is-bordered is-centered" cellspacing="2">
                    <thead>
                        <tr>
                            <th>Turkeys</th>
                            <th>Sprouts</th>
                            <th>Spuds</th>
                            <th>Puddings</th>
                            <th>Roasters</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                Dom<br>
                                James<br>
                                Kevin<br>
                                Adam
                            </td>

                            <td>
                                Dave S<br>
                                Mat<br>
                                Joe<br>
                                Dave F
                            </td>

                            <td>
                                Stuart L<br>
                                Joe B<br>
                                Phil<br>
                                Alfi
                            </td>

                            <td>
                                Lynton<br>
                                Roberto<br>
                                Tamas<br>
                                Dan B
                            </td>

                            <td>
                                Brett<br>
                                Neil<br>
                                Sean<br>
                                Ronan<br>
                                Mark W
                            </td>
                        </tr>
                    </tbody>
                </table>

            </div>

            <div class="animated zoomInDown delay-intro" style="margin-top: 20px;">
                <p class="animated pulse infinite">Team Leaders connect to<br>https://quiz.d3r.com<br>Using your phone!</p>
            </div>
        </div>

        <div id="teambuzzers" style="display: none;"></div>

        <script src="/socket.io/socket.io.js"></script>
        <script src="js/jquery-1.11.1.js"></script>

        <script>
            $(function () {
                var teams = [];
                var timerId, timerTimer;

                // Mmmm shimmy
                function toggleFullScreen() {
                    if (!document.fullscreenElement &&
                        !document.mozFullScreenElement &&
                        !document.webkitFullscreenElement &&
                        !document.msFullscreenElement) {
                        if (document.documentElement.requestFullscreen) {
                            document.documentElement.requestFullscreen();
                        } else if (document.documentElement.msRequestFullscreen) {
                            document.documentElement.msRequestFullscreen();
                        } else if (document.documentElement.mozRequestFullScreen) {
                            document.documentElement.mozRequestFullScreen();
                        } else if (document.documentElement.webkitRequestFullscreen) {
                            document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
                        }
                    } else {
                        if (document.exitFullscreen) {
                            document.exitFullscreen();
                        } else if (document.msExitFullscreen) {
                            document.msExitFullscreen();
                        } else if (document.mozCancelFullScreen) {
                            document.mozCancelFullScreen();
                        } else if (document.webkitExitFullscreen) {
                            document.webkitExitFullscreen();
                        }
                    }
                }
                document.addEventListener("keypress", function(e) {
                    $('#presskey').hide();
                    if (e.keyCode === 102) {
                        toggleFullScreen();
                    }
                }, false);

                function stopAllSound() {
                    $('audio').each(function () {
                        $(this)[0].pause();
                        $(this)[0].currentTime = 0;
                    });
                }

                var socket = io.connect('/dashboard'),
                    wrongTimer = null;

                socket.on('question play', function (msg) {
                    stopAllSound();

                    $('header').hide();
                    $('section').hide();
                    $('.title').hide();
                    $('#question').html('');

                    $('#question')
                    .append(
                        $('<h1/>')
                            .addClass('animated')
                            .addClass('zoomInDown')
                            .html(msg.question.title)
                    );

                    switch (msg.question.type) {
                        case 'timer':
                        case 'text':
                            $('#question').append(
                                $('<div />').append(
                                    $('<span />')
                                        .addClass('content')
                                        .addClass('animated')
                                        .addClass('zoomInDown')
                                        .addClass('delay-1s')
                                        .html(msg.question.text)
                                )
                            );

                            if (msg.question.type == 'timer') {
                                let timer = $('#timer').clone();
                                timerId = "timer_" + Math.floor(Math.random() * 1000);
                                $(timer).attr("id", timerId);
                                $(timer).show();
                                $('#question div').append(timer);
                            }
                            break;

                        case 'audio':
                            let icon = $('#icon_music').clone();
                            $(icon).attr("id","");
                            $('#question').append(icon);
                            break;
                    }

                    $('#question').show();
                });

                function timerRun () {
                    let time = parseInt($('#' + timerId + ' span').html());
                    --time;

                    $('#' + timerId + ' span').html(time);

                    if (time < 1) {
                        $('#timer_horn')[0].play();
                        clearInterval(timerTimer);
                    } else if (time < 6) {
                        $('#timer_tick')[0].play();
                    }
                }
                socket.on('question timer', function (event) {
                    if (!timerId)
                        return;

                    switch (event.action) {
                        case 'start':
                            timerTimer = setInterval(timerRun, 1000);
                            break;

                        case 'pause':
                            clearInterval(timerTimer);
                            break;

                        case 'reset':
                            clearInterval(timerTimer);
                            $('#' + timerId + ' span').html(60);
                            break;
                    }
                });

                socket.on('sound play', function (sound) {
                    stopAllSound();
                    $('#' + sound.sound)[0].play();
                });

                socket.on('title show', function (event) {
                    $('header').hide();
                    $('section').hide();
                    $('.title').hide();
                    $('#title_' + event.title.title).show();
                    if (event.title.audio) {
                        $('#' + event.title.audio)[0].play();
                    }

                    if (event.title.title == 'outro') {
                        var ts = event.teams;
                        ts.sort((a, b) => parseFloat(b.points) - parseFloat(a.points));

                        var s = 1;
                        for (let t in ts) {
                            $('#outroteams').append(
                                '<div class="animated zoomInDown delay-' + s +
                                's" style="font-size: ' + (200 - (20 * s)) + '%;">' +
                                (s == 1 ? '**WINNER**' : '') +
                                ts[t].name + ' (' + ts[t].points +
                                (ts[t].points == 1 ? ' point' : ' points') + ')</div>'
                            );
                            s++;
                        }
                    }
                });

                socket.on('sound stop', function () {
                    stopAllSound();
                });

                socket.on('question buzzed', function (event) {
                    stopAllSound();

                    if ($('#audio_team_' + event.team.id).length) {
                        $('#audio_team_' + event.team.id)[0].play();
                    } else {
                        $('#' + event.sound)[0].play();
                    }

                    $('#teamoverlay').html('').append(
                        $('<div />')
                            .addClass('animated')
                            .addClass('zoomInDown')
                            .html(event.team.name)
                    ).show();
                })
                .on('question wrong', function (event) {
                    $('#' + event.sound)[0].play();
                    $('#teamoverlay').html('').hide();
                    $('#answer_wrong').show();

                    wrongTimer = window.setTimeout(
                        function() {
                            $('#answer_wrong').hide();
                        },
                        3000
                    );
                })
                .on('question correct', function (event) {
                    window.clearTimeout(wrongTimer);
                    $('#' + event.sound)[0].play();
                    $('#teamoverlay').html('').hide();
                    $('#answer_correct').show();
                })
                .on('question losers', function (event) {
                    window.clearTimeout(wrongTimer);
                    $('#' + event.sound)[0].play();
                    $('#teamoverlay').html('').hide();
                    $('#answer_losers').show();
                })
                .on('teams list', function(ts) {
                    teams = ts;
                    for (let t in teams) {
                        let team = teams[t];
                        if (team.buzzer != null) {
                            if (!$('#audio_team_' + team.id).length) {
                                var audio = document.createElement('audio');
                                audio.setAttribute('controls', '');
                                audio.setAttribute('id', 'audio_team_' + team.id);
                                $('#teambuzzers')[0].appendChild(audio);
                            }

                            var buzzerBlob = new Blob([team.buzzer], { 'type' : 'audio/ogg; codecs=opus' });
                            var audioURL = window.URL.createObjectURL(buzzerBlob);
                            $('#audio_team_' + team.id)[0].src = audioURL;
                        }
                    }
                })
                .on('teams scores', function(event) {
                    $('#teamscorelist').empty();
                    teams = event.teams;
                    var ts = teams;
                    ts.sort((a, b) => parseFloat(b.points) - parseFloat(a.points));

                    var s = 1;
                    for (let t in ts) {
                        $('#teamscorelist').append(
                            '<div class="animated zoomInDown delay-' + s +
                            's" style="font-size: ' + (200 - (20 * s)) + '%;">' +
                            ts[t].name + ' (' + ts[t].points +
                            (ts[t].points == 1 ? ' point' : ' points') + ')</div>'
                        );
                        s++;
                    }

                    window.setTimeout(
                        function() {
                            stopAllSound();
                            $('section').hide();
                            $('#teamscores').show();
                        },
                        3000
                    );
                });
            });
        </script>
    </body>
</html>
