<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>Quiz Contestant</title>

        <link href="css/nes.min.css" rel="stylesheet" />
        <link href="css/animate.css" rel="stylesheet" />
        <link href="css/style.css" rel="stylesheet" />

        <style>
            #teams, #killed, #err, #wait { display: none; }
            header h1 { font-size: 200%; }

            .bcrikko { top: 60px; }
            .messages { padding-bottom: 10px; }

            #buttons {
                display: none;
                width: 100%;
                height: 100%;
                text-align: center;
                font-size: 200%;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>D3R Xmas Quiz!</h1>
        </header>

        <section id="err"></section>

        <section id="killed" class="balloon container with-title">
            <div class="messages">
                <div class="message -left">
                    <i class="bcrikko"></i>
                    <div class="balloon from-left">
                        <p>You've been eaten by a grue, thanks for playing!</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="wait" class="loading">
            <p class="animated pulse infinite">Please Wait</p>
        </section>

        <section id="buttons">
            <button type="button" id="buzzer" class="btn is-success">BUZZER</button>
        </section>

        <section id="teams" class="container with-title">
            <h2 class="title">Select Team</h2>
            <div class="containers list" />
        </section>

        <script src="/socket.io/socket.io.js"></script>
        <script src="js/jquery-1.11.1.js"></script>
        <script>
            $(function () {
                var socket = io('/contestant'),
                    cid    = window.localStorage.getItem('cid');

                console.log('My id: ' + cid);

                $('form').submit(function () {
                    socket.emit('chat message', $('#m').val());
                    $('#m').val('');
                    return false;
                });

                $('#c').on('click', function () {
                    console.log('Cleared ID');
                    window.localStorage.removeItem('cid');
                    cid = null;
                });

                $('#buzzer').on('click', function () {
                    socket.emit('buzzer send', cid);
                    $('#buzzer').removeClass('is-success').addClass('is-error').prop("disabled", true);
                });

                function buttonView () {
                    $('section').hide();
                    $('#buttons').show();
                    $('#buzzer').addClass('is-success').removeClass('is-error').prop("disabled", false);
                }

                socket
                .on('teams list', function (teams) {
                    $('#teams .list').html('');
                    $(teams).each(function(k, v) {
                        $('#teams .list').append(
                            $('<button/>')
                                .addClass('btn')
                                .addClass('is-error')
                                .text(v.name)
                                .on('click', function() {
                                    $('#err').html("").hide();
                                    socket.emit('team join', k);
                                })
                        ).append("<br/>");
                    });
                    $('#teams').show();
                })
                .on('teams invalid', function () {
                    $('#err').html("Invalid Team Choice").show();
                })
                .on('wait', function() {
                    $('section').hide();
                    $('#wait').show();
                })
                .on('question play', function(options) {
                    buttonView();
                })
                .on('question chance', function(options) {
                    buttonView();
                })
                .on('question disable', function(options) {
                    $('#buzzer').removeClass('is-success').addClass('is-error').prop("disabled", true);
                })
                .on('reconnect', function (msg) {
                    $('section').hide();
                    socket.emit('ident', cid);
                    console.log("Reconnected");
                })
                .on('connect', function (msg) {
                    socket.emit('ident', cid);
                    console.log("Connected");
                })
                .on('order 66', function (msg) {
                    window.localStorage.removeItem('cid');
                    cid = null;
                    $('section').hide();
                    $('#killed').show();
                    console.log("execute order 66");
                })
                .on('id', function (id) {
                    console.log('Got ID: ' + id);
                    cid = id;
                    window.localStorage.setItem('cid', cid);
                });
            });
        </script>
    </body>
</html>
