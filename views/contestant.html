<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />

        <title>Quiz Contestant</title>

        <link href="css/nes.min.css" rel="stylesheet" />
        <link href="css/animate.css" rel="stylesheet" />
        <link href="css/style.css" rel="stylesheet" />

        <style>
            #teams, #killed, #err, #wait, #menu, #bMenu { display: none; }
            header h1 { font-size: 200%; }

            .bcrikko { top: 60px; }
            .messages { padding-bottom: 10px; }

            #buttons {
                display: none;
                width: 100%;
                height: 100%;
                text-align: center;
                font-size: 200%;
            }

            #menu {
                background-color: #00b5cc;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                padding: 20px;
                border: 1px solid #fff;
                box-shadow: inset 0 0 100px black;
                text-align: center;
            }

            #bMenu {
                position: absolute;
                bottom: 0;
                right: 0;
            }

            .recorder {
                margin: 20px;
            }
        </style>
    </head>
    <body>
        <header>
            <h1>D3R Xmas Quiz!</h1>
        </header>

        <section id="err"></section>

        <section id="killed" class="balloon container with-title">
            <div class="messages">
                <div class="message -left">
                    <i class="bcrikko"></i>
                    <div class="balloon from-left">
                        <p>You've been eaten by a grue, thanks for playing!</p>
                    </div>
                </div>
            </div>
        </section>

        <section id="wait" class="loading">
            <p class="animated pulse infinite">Please Wait</p>
        </section>

        <section id="buttons">
            <button type="button" id="buzzer" class="btn is-success">BUZZER</button>
        </section>

        <button type="button" id="bMenu" class="btn is-success">MENU</button>

        <section id="menu" class="container">
            <h2 class="title">Team Settings</h2>
            <div class="field">
                <label for="name_field">Team name</label>
                <input type="text" id="name_field" class="input" style="display: inline-block">
            </div>

            <audio id="aBuzzer"></audio>
            Team Buzzer <button type="button" id="bRecord" class="btn is-success">Record</button>
            <button type="button" id="bPlay" class="btn is-success">Play</button><br><br>

            <button type="button" id="bCancel" class="btn is-warning">CANCEL</button>
            <button type="button" id="bSave" class="btn is-success">SAVE</button>
        </section>

        <section id="teams" class="container with-title">
            <h2 class="title">Select Team</h2>
            <div class="containers list" />
        </section>

        <script src="/socket.io/socket.io.js"></script>
        <script src="js/jquery-1.11.1.js"></script>
        <script>
            $(function () {
                var socket = io('/contestant'),
                    cid    = window.localStorage.getItem('cid'),
                    buzzerBlob = null;

                console.log('My id: ' + cid);

                $('#c').on('click', function () {
                    window.localStorage.removeItem('cid');
                    cid = null;
                });

                $('#buzzer').on('click', function () {
                    socket.emit('buzzer send', cid);
                    $('#buzzer').removeClass('is-success').addClass('is-error').prop("disabled", true);
                });

                $('#bMenu').on('click', function () {
                    $('#menu').show();
                    $('#bMenu').hide();
                });
                $('#bSave').on('click', function () {
                    var settings = {
                        name: $('#name_field').val()
                    };


                    socket.emit('team update', settings);
                    socket.emit('team buzzer', buzzerBlob);
                    $('#menu').hide();
                    $('#bMenu').show();
                });
                $('#bCancel').on('click', function () {
                    $('#menu').hide();
                    $('#bMenu').show();
                });

                function buttonView () {
                    $('section').hide();
                    $('#buttons').show();
                    $('#buzzer').addClass('is-success').removeClass('is-error').prop("disabled", false);
                }

                socket
                .on('teams list', function (teams) {
                    $('#teams .list').html('');
                    $(teams).each(function(k, v) {
                        $('#teams .list').append(
                            $('<button/>')
                                .addClass('btn')
                                .addClass('is-error')
                                .text(v.name)
                                .on('click', function() {
                                    $('#err').html("").hide();
                                    socket.emit('team join', k);
                                })
                        ).append("<br/>");
                    });
                    $('#teams').show();
                })
                .on('teams invalid', function () {
                    $('#err').html("Invalid Team Choice").show();
                })
                .on('wait', function() {
                    $('section').hide();
                    $('#wait').show();
                    $('#bMenu').show();
                })
                .on('question play', function(options) {
                    buttonView();
                })
                .on('question chance', function(options) {
                    buttonView();
                })
                .on('question disable', function(options) {
                    $('#buzzer').removeClass('is-success').addClass('is-error').prop("disabled", true);
                })
                .on('reconnect', function (msg) {
                    $('section').hide();
                    socket.emit('ident', cid);
                })
                .on('connect', function (msg) {
                    socket.emit('ident', cid);
                })
                .on('game state', function (state) {
                    if (state.team) {
                        team = state.team;
                        $('#bMenu').show();
                        $('#name_field').val(team.name);

                        if (state.question) {
                            buttonView();
                            if (state.answered) {
                                $('#buzzer').removeClass('is-success').addClass('is-error').prop("disabled", true);
                            }
                        }
                    }
                })
                .on('order 66', function (msg) {
                    window.localStorage.removeItem('cid');
                    cid = null;
                    $('section').hide();
                    $('#killed').show();
                    console.log("execute order 66");
                })
                .on('id', function (id) {
                    console.log('Got ID: ' + id);
                    cid = id;
                    window.localStorage.setItem('cid', cid);
                });

                // Team sound recorder
                var mediaRecorder, recording = false, buzzerChunks = [];
                $('#bRecord').on('click', function () {
                    if (recording) {
                        mediaRecorder.stop();
                        recording = false;
                        $(this).addClass('is-success').removeClass('is-error');
                        return;
                    }
                    recording = true;
                    mediaRecorder.start();
                    buzzerChunks = [];
                    $(this).removeClass('is-success').addClass('is-error');
                });

                $('#bPlay').on('click', function () {
                    if (!buzzerChunks)
                        return;
                    $('#aBuzzer')[0].play();
                });
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                   console.log('getUserMedia supported.');
                   navigator.mediaDevices.getUserMedia({audio: true})
                        .then(function(stream) {
                            mediaRecorder = new MediaRecorder(stream);

                            mediaRecorder.ondataavailable = function(e) {
                                buzzerChunks.push(e.data);
                            }

                            mediaRecorder.onstop = function(e) {
                                buzzerBlob = new Blob(buzzerChunks, { 'type' : 'audio/ogg; codecs=opus' });
                                var audioURL = window.URL.createObjectURL(buzzerBlob);
                                $('#aBuzzer')[0].src = audioURL;
                            }
                        })
                        .catch(function(err) {
                            console.log('The following getUserMedia error occured: ' + err);
                        });
                } else {
                   console.log('getUserMedia not supported on your browser!');
                }
            });
        </script>
    </body>
</html>
